<!--modified hero layout-->

{{ $disableImageOptimization := .Site.Params.disableImageOptimization | default false }}
{{ $disableHeroImageFilter := .Site.Params.homepage.disableHeroImageFilter | default false }}

{{ $imageBreakpointSmall := "450px" }}
{{ $imageBreakpointMedium := "600px" }}
{{ $imageBreakpointLarge := "750px" }}
{{ partial "home/hero-image-rendition.html" . }}

<!-- an approximation of the homepage hero content for people using screen readers -->
<div class="sr-only">
  <h1>Critical Signals</h1>
  <ul>
    <!-- interleave the images with the questions, as evenly spaced as possible -->
    {{ $questionCount := len .Params.questions }}
    {{ $imageCount := len .Params.imageAltTexts }}
    {{ $questionsPerGroup := div $questionCount $imageCount }}
    
    {{ range $index, $question := .Params.questions }}
    <li>{{ $question }}</li>
    
    {{ $currentGroup := div $index $questionsPerGroup }}
    {{ $isEndOfGroup := eq (mod $index $questionsPerGroup) (sub $questionsPerGroup 1) }}
    {{ $isLastQuestion := eq $index (sub $questionCount 1) }}
    {{ $canInsertImage := lt $currentGroup $imageCount }}
    
    {{ if and (or $isEndOfGroup $isLastQuestion) $canInsertImage }}
    <li><img src="" alt="{{ index $.Params.imageAltTexts $currentGroup }}"></li>
    {{ end }}
    {{ end }}
  </ul>
</div>

<div class="homepage-hero">
  <!-- .homepage-hero__picture will be inserted here -->
  <div class="homepage-hero__content" aria-hidden="true">
    <div id="target-question" class="question">
      How many<br />
      devices is a<br />
      lifetime
    </div>

    <img class='logo' alt="" src="/logo.svg" />
  </div>
</div>

<section class="prose prose-invert">
  {{ .Content }}
</section>

<section>
  {{ partial "recent-articles/main.html" . }}
</section>

<section class='partners'>
  <img alt="Goethe Institut" src="/images/partners/cream_Logo_Goethe_Institut.svg">
  <img alt="Victoria University of Wellington" src="/images/partners/cream_victoria_logo.svg" >
  <img alt="Monash University" src="/images/partners/cream_Monash_University_logo.svg" >
  <img alt="Massey University" src="/images/partners/cream_Massey_University_Logo.svg" >
  <img alt="Toi Aria" src="/images/partners/cream_Toi_Aria_Logo.svg" >
</section>

<script>
const questions = {{ .Params.questions }}
const processedImages = window.heroImages || []

let currentImageIndex = 0
let isTransitioning = false

const heroContainer = document.querySelector('.homepage-hero')
const imageBreakpointSmall = "{{ $imageBreakpointSmall }}"
const imageBreakpointMedium = "{{ $imageBreakpointMedium }}"
const imageBreakpointLarge = "{{ $imageBreakpointLarge }}"

const createPictureElement = (imageSet) => {
  const picture = document.createElement('picture')
  picture.className = 'homepage-hero__picture'
  
  const sourceMap = [
    { media: `(min-width: ${imageBreakpointLarge})`, srcset: imageSet.large },
    { media: `(min-width: ${imageBreakpointMedium})`, srcset: imageSet.medium },
    { media: `(min-width: ${imageBreakpointSmall})`, srcset: imageSet.small }
  ]

  sourceMap.forEach(({ media, srcset }) => {
    const source = document.createElement('source')
    source.media = media
    source.srcset = srcset
    picture.appendChild(source)
  })

  const img = document.createElement('img')
  img.src = imageSet.base
  img.alt = ''
  img.className = 'nozoom'
  img.id = 'target-hero'
  picture.appendChild(img)

  return picture
}

const prefetchImage = (imageSet) => {
  return new Promise((resolve) => {
    const img = new Image()
    img.onload = () => resolve(imageSet)
    img.onerror = () => resolve(imageSet)
    img.src = imageSet.base
  })
}

const getNextImageIndex = (currentIndex, maxIndex) => {
  const allIndices = Array.from({ length: maxIndex }, (_, i) => i)
  const availableIndices = allIndices.filter(i => i !== currentIndex)
  return availableIndices[Math.floor(Math.random() * availableIndices.length)]
}

const setHeroImage = async () => {
  if (processedImages.length <= 1 || isTransitioning) return
  
  isTransitioning = true
  
  const nextImageIndex = getNextImageIndex(currentImageIndex, processedImages.length)
  const nextImageSet = processedImages[nextImageIndex]
  
  // Pre-fetch the next image
  await prefetchImage(nextImageSet)
  
  // Create new picture element
  const newPicture = createPictureElement(nextImageSet)
  
  // Insert new picture behind current one
  const content = heroContainer.querySelector('.homepage-hero__content')
  heroContainer.insertBefore(newPicture, content)
  
  // Force a reflow to ensure the new picture is rendered
  newPicture.offsetHeight
  
  // Find and fade out current active picture
  const currentPicture = heroContainer.querySelector('.homepage-hero__picture.active')
  
  // Fade in new picture
  newPicture.classList.add('active')
  
  // After transition, remove old picture
  setTimeout(() => {
    if (currentPicture) {
      currentPicture.remove()
    }
    currentImageIndex = nextImageIndex
    isTransitioning = false
  }, 100)
}

const setHeroText = () => {
  const text = questions[Math.floor(Math.random() * questions.length)]
  const heroTextEl = document.getElementById('target-question')
  heroTextEl.innerText = text
}

// Initialize with first image
const initializeHero = async () => {
  if (processedImages.length > 0) {
    const initialImageSet = processedImages[0]
    await prefetchImage(initialImageSet)
    const initialPicture = createPictureElement(initialImageSet)
    initialPicture.classList.add('active')
    
    const content = heroContainer.querySelector('.homepage-hero__content')
    heroContainer.insertBefore(initialPicture, content)
  }
  
  setHeroText()
  
  // Start intervals
  const PERIOD = 7000
  setInterval(setHeroText, PERIOD)
  setInterval(setHeroImage, PERIOD)
}

// Start the hero
initializeHero()
</script>

<style>
:where(body):has(.homepage-hero) {
  /* this page's components will handle their own inline spacing */
  margin: unset;
  padding-inline: unset;
  max-inline-size: unset;

  :where(.main-menu, main > *, footer) {
    /* the same content container styles are applied to each component, so they 
    can be individually overridden as needed (e.g. for full-bleed layouts) */
    width: 100%;
    max-width: var(--content-max-width-plus-gutters);
    margin-inline: auto;
    padding-inline: var(--page-gutter);
  }
  /* main-menu's padding is set inline though, so higher specificity is needed */
  .main-menu {
    padding-inline: var(--page-gutter) !important;
    max-width: var(--container-7xl);
  }
}

.homepage-hero {
  /* allow children (specifically the image) to be full-bleed */
  max-width: unset;
  margin-inline: unset;
  padding-inline: unset;

  height: clamp(25rem, 62.5vw, 30rem); 
  display: grid;
  grid-template-rows: minmax(0, 1fr); /* https://css-tricks.com/preventing-a-grid-blowout/ */
  grid-template-areas: "a"; 
  place-items: center;
  margin-bottom: 2rem;

  & > * {
    /* picture + content will be overlaid in the same area */
    grid-area: a;
    width: 100%;
    height: 100%;
  }
}

.homepage-hero__picture {
  overflow: hidden;
  opacity: 0;
  transition: opacity 100ms ease-in-out;
  
  &.active { 
    opacity: 1;
  }

  :where(img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
}

.homepage-hero__content {
  /*  standard content container settings */
  max-width: var(--content-max-width-plus-gutters);
  margin-inline: auto;
  padding-inline: var(--page-gutter);

  padding-block: 4.5rem 3.5rem;
  display: grid;
  align-content: space-between;
  
  @media (min-width: 768px) {
    padding-block: 5rem 4rem;
   }
  @media (min-width: 1024px) {
    padding-block: 4rem 3rem;
   }

  :where(.question) {
    justify-self: start;
    max-width: 40rem;
    font-size: 2.5rem;
    line-height: 1.125;
    font-family: bold_font;
    text-transform: uppercase;
    text-wrap: balance;
    filter: drop-shadow(0 0 5px rgba(0,0,0, 0.2));

    @media (min-width: 768px) {
      font-size: 4rem;
    }
  }

  :where(.logo) {
    height: 3rem;
    justify-self: end;
    filter: drop-shadow(0 0 5px rgba(0,0,0, 0.6));

    @media (min-width: 768px) {
      height: 4rem;
    }
  }
}


.prose {
  margin-bottom: 3rem;
}

/* Partners section */
.partners {
  margin: 6rem -1rem 4rem -1rem;
  max-width: calc(100% + 2rem);
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-content: center;
  gap: 2rem;

  @media (min-width: 768px) {
    gap: 3rem;
  }

  :where(img) {
    max-height: 5rem;
    min-width: 25%;
    max-width: calc(100% / 2 - 2rem);
    
    @media (min-width: 768px) {
      max-width: calc(100% / 3 - 2rem);
    }
  }
}
</style>
